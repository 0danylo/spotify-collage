<!doctype html>
<html>
<head>
    <title>Spotify Playlist Collage</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
        #login, #loggedin {
            display: none;
        }

        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 500px;
        }

        #container {
            height: 100%;
            width: 100%;
            font-size: 0;
        }

        #pl-name, #pl-cover, #collage-options, #pl-button {
            display: inline-block;
            *display: inline;
            zoom: 1;
            vertical-align: center;
            horiz-align: center;
            font-size: 24px;
            width: 25%
        }
    </style>
</head>

<body>
<div class="container">
    <div id="login">
        <h1>Playlist Collage</h1>
        <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin">
        <div id="user-profile">
        </div>
        <button class="btn btn-default" id="get-playlists">Get Playlists</button>
    </div>
</div>

<script id="user-profile-template" type="text/x-handlebars-template">
    <h1>Logged in as {{display_name}}</h1>
    <div class="media">
        <div class="pull-left">
            <img class="media-object" width="150" src="{{images.0.url}}"/>
        </div>
        <div class="media-body">
            <dl class="dl-horizontal">
                <dt>Display name</dt>
                <dd class="clearfix">{{display_name}}</dd>
                <dt>Id</dt>
                <dd>{{id}}</dd>
                <dt>Email</dt>
                <dd>{{email}}</dd>
                <dt>Spotify URI</dt>
                <dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
                <dt>Link</dt>
                <dd><a href="{{href}}">{{href}}</a></dd>
                <dt>Profile Image</dt>
                <dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
                <dt>Country</dt>
                <dd>{{country}}</dd>
            </dl>
        </div>
    </div>
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script>
    (() => {
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        let userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        const params = getHashParams();

        const access_token = params.access_token,
            error = params.error;

        let userID, offset = 0, limit = 50; //supports up to 50 playlists
        let playlists = new Array(), tracks

        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (access_token) {
                $.ajax({ //get the user's profile
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    success: (response) => {
                        userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                        userID = response.id
                        $('#login').hide();
                        $('#loggedin').show();

                        request(`https://api.spotify.com/v1/users/${userID}/playlists`).done((data) => {
                            playlists = data.items

                            document.body.innerHTML += '<hr>'
                            for (let i = 0; i < playlists.length; i++) {
                                document.body.innerHTML +=
                                    '<div id=container>' +
                                    '<div id="pl-name" style="padding-left: 100px;"><font size="5">' + playlists[i].name + '</font></div>' +
                                    '<div id="pl-cover"><img src=' + playlists[i].images[0].url + ' width=150 height=150></div>' +
                                    '<div id="pl-button"><button id="collage-btn' + i + '">Create collage</button></div>' +
                                    '<hr></div>'
                            }

                            for (let i = 0; i < playlists.length; i++) {
                                document.getElementById('collage-btn' + i).addEventListener('click', () => {
                                    tracks = new Array()
                                    getTracks(`https://api.spotify.com/v1/playlists/${playlists[i].id}/tracks`)
                                }, false);
                            }
                        })
                    }
                });

            } else { //authentication unsuccessful
                $('#login').show();
                $('#loggedin').hide();
            }

            const request = (url) => { //make a request (for a playlist or its tracks)
                return $.ajax({
                    url: url,
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    data: {
                        'limit': limit
                    }
                })
            }

            const getPlaylists = (url) => { //doesn't work because of asynchronicity
                request(url).done((data) => {
                    for (let i = 0; i < data.items.length; i++) {
                        playlists.push(data.items[i])
                    }
                    console.log(data)
                    if (data.next !== null) {
                        getPlaylists(data.next)
                    }
                })
            }

            const getTracks = (url) => { //get the tracks in a playlist
                request(url).done((data) => {
                    for (let i = 0; i < data.items.length; i++) {
                        tracks.push(data.items[i])
                    }
                    console.log(data)
                    if (data.next !== null) {
                        getTracks(data.next)
                    }
                })
            }

        }
    })();
</script>
</body>
</html>
